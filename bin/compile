#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR

# fail fast
set -e

BUILD_DIR="$1"
CACHE_DIR="$2"

. bin/common

curl --silent --location http://heroku-jvm-common.s3.amazonaws.com/jvm-buildpack-common.tar.gz | tar xz
. bin/java

# recreate cache dir if it doesn't exit
mkdir -p $CACHE_DIR

# create default system.properties
if [ ! -f ${BUILD_DIR}/system.properties ]; then
  echo "java.runtime.version=1.6" > ${BUILD_DIR}/system.properties
fi

# install JDK
javaVersion=$(detect_java_version ${BUILD_DIR})
echo -n "-----> Installing OpenJDK ${javaVersion}..."
install_java ${BUILD_DIR} ${javaVersion}
jdk_overlay ${BUILD_DIR}
echo " done"

# detect container
container=$(get_app_system_value ${BUILD_DIR}/container.properties "container")
echo "-----> Detected container ${container}..."

# check container support
supportedContainers=$(get_supported_containers)
if [[ ! "${supportedContainers[*]}" =~ "$container" ]]; then
    echo "-----> Unsupported container!" && exit 1
fi

# download container
containerUrl=$(get_container_url ${container})
echo -n "-----> Downloading ${containerUrl}..."
containerFile=$(basename "${containerUrl}")
if [ -f "${CACHE_DIR}/$containerFile" ]; then
    echo " found cached copy"
else
    curl --silent --location "${containerUrl}" > "${CACHE_DIR}/$(basename ${containerUrl})"
    echo " done"
fi

# install container
rm -rf ${BUILD_DIR}/container
mkdir -p ${BUILD_DIR}/container
echo -n "-----> Installing container..."
tar xf "${CACHE_DIR}/$containerFile" -C ${BUILD_DIR}/container --strip-components 1
